<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BoardDao">

  <resultMap id="BoardMap" type="Board">
    <id property="no" column="board_no"/>
    <result property="title" column="title"/>
    <result property="content" column="content"/>
    <result property="createdDate" column="created_date"/>
    <result property="fileCount" column="file_count"/>
    <result property="category" column="category"/>
    <association property="writer" javaType="Member">
      <id property="no" column="member_no"/>
      <result property="name" column="name"/>
    </association>

    <collection property="files" ofType="AttachedFile">
      <id column="file_no" property="no"/>
      <result column="file_path" property="filePath"/>
      <result column="board_no" property="boardNo"/>
    </collection>

  </resultMap>

  <insert id="add" parameterType="Board"
    useGeneratedKeys="true" keyColumn="board_no" keyProperty="no">
    <!-- preparedstatement에서 return generated_keys를 쓰는 것과 같다 받은 리턴값 KeyColumn 에서 값을 지정하고 담아줄 변수를 property에 지정-->
    insert into boards(title,content,writer,category) values(#{title},#{content},#{writer.no},#{category})
  </insert>
  <delete id="delete" parameterType="int">
    delete from boards where board_no=#{no}
  </delete>
  <select id="findAll" parameterType="int" resultMap="BoardMap">
    select
      b.board_no,
      b.title,
      b.created_date,
      count(file_no) file_count,
      m.member_no,
      m.name
    from
      boards b left outer join board_files bf on b.board_no=bf.board_no
      inner join members m on b.writer=m.member_no
    where
      b.category=#{no}
    group by
      board_no
    order by
      board_no desc
  </select>
  <select id="findBy" resultMap="BoardMap" parameterType="int">
    select
      b.board_no,
      b.title,
      b.content,
      b.created_date,
      m.member_no,
      m.name,
      bf.file_no,
      bf.file_path
    from
      boards b inner join members m on b.writer=m.member_no
      left outer join board_files bf on b.board_no = bf.board_no
    where
      b.board_no=#{no}
  </select>
  <update id="update" parameterType="Board">
    update boards set title=#{title}, content=#{content} where board_no=#{no}
  </update>
</mapper>